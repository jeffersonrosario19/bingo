<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BingÃ£o do Caranguejo</title>
  <style>
    /* TODO O SEU CSS ORIGINAL AQUI - mantenha igual */
  </style>
</head>
<body>

  <!-- Banner -->
  <div class="banner">
    <img src="assets/banner-bingao.jpg" alt="Banner do BingÃ£o do Caranguejo" />
  </div>

  <h1>BingÃ£o do Caranguejo</h1>
  <p class="subtitulo">Escolha jÃ¡ a sua cartela e concorra a valiosos prÃªmios!</p>

  <div id="cartelas"></div>

  <!-- BotÃ£o fixo de reservar -->
  <button id="botaoFixo" onclick="abrirFormulario()">ðŸ“± Reservar (0 cartelas)</button>

  <!-- Modal da imagem real -->
  <div id="modalImagem" onclick="fecharModal(event)">
    <div id="modalConteudo" onclick="event.stopPropagation()">
      <button id="fecharModal" onclick="fecharModal()">Ã—</button>
      <img src="" alt="Imagem da Cartela" id="imagemReal" />
    </div>
  </div>

  <!-- Popup FormulÃ¡rio reserva -->
  <div id="popup-bg">
    <div id="popup">
      <button id="fechar" onclick="fecharFormulario()">Ã—</button>
      <h3>Reservar Cartelas</h3>
      <p>Cartelas selecionadas:</p>
      <ul id="listaSelecionadas"></ul>
      <label for="nome">Nome:</label><br/>
      <input type="text" id="nome" placeholder="Seu nome" /><br/>
      <label for="whatsapp">WhatsApp:</label><br/>
      <input type="text" id="whatsapp" placeholder="Seu WhatsApp" /><br/>
      <button class="btn-reservar" onclick="enviarReserva()">Enviar Reserva</button>
    </div>
  </div>

  <script>
    let cartelas = [];
    const cartelasPorSequencia = 10;
    const sequencias = [];
    let selecionadas = new Set();

    const container = document.getElementById('cartelas');
    const botaoFixo = document.getElementById('botaoFixo');
    const popupBg = document.getElementById('popup-bg');
    const listaSelecionadas = document.getElementById('listaSelecionadas');
    const imagemReal = document.getElementById('imagemReal');
    const modalImagem = document.getElementById('modalImagem');

    async function carregarCartelas() {
      try {
        const response = await fetch('assets/status.csv');
        const text = await response.text();

        const linhas = text.trim().split('\n');
        const dados = linhas.slice(1);

        cartelas = dados.map(linha => {
          const [numero, status] = linha.split(',');
          const id = parseInt(numero.trim());
          return {
            id,
            status: status.trim().toLowerCase()
          };
        });

        cartelas.sort((a, b) => a.id - b.id);

        const totalSequencias = Math.ceil(cartelas.length / cartelasPorSequencia);
        for (let i = 0; i < totalSequencias; i++) {
          const grupo = cartelas.slice(i * cartelasPorSequencia, (i + 1) * cartelasPorSequencia);
          criarSequenciaCards(grupo, i === 0);
        }
      } catch (erro) {
        console.error('Erro ao carregar o CSV:', erro);
        container.innerHTML = '<p style="color:red;">Erro ao carregar os dados das cartelas.</p>';
      }
    }

    function criarSequenciaCards(cartelasDoGrupo, ativa = false) {
      const seqDiv = document.createElement('div');
      seqDiv.className = 'sequencia';

      const h2 = document.createElement('h2');
      const ini = cartelasDoGrupo[0].id;
      const fim = cartelasDoGrupo[cartelasDoGrupo.length - 1].id;
      h2.textContent = `Cartelas de ${ini} a ${fim}`;
      h2.onclick = () => {
        sequencias.forEach(s => {
          if (s.div !== seqDiv) s.cardsDiv.style.display = 'none';
        });
        const atual = seqDiv.querySelector('.cards-scroll');
        atual.style.display = atual.style.display === 'flex' ? 'none' : 'flex';
      };

      const cardsDiv = document.createElement('div');
      cardsDiv.className = 'cards-scroll';
      cardsDiv.style.display = ativa ? 'flex' : 'none';

      cartelasDoGrupo.forEach(c => {
        const card = document.createElement('div');
        card.className = 'card';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = `chk-${c.id}`;
        checkbox.checked = selecionadas.has(c.id);
        checkbox.disabled = c.status !== 'livre';

        checkbox.onclick = (e) => {
          e.stopPropagation();
          if (checkbox.checked) {
            selecionadas.add(c.id);
          } else {
            selecionadas.delete(c.id);
          }
          atualizarBotaoFixo();
          atualizarListaSelecionadas();
        };
        card.appendChild(checkbox);

        const numero = document.createElement('div');
        numero.className = 'numero-cartela';
        numero.textContent = c.id;
        card.appendChild(numero);

        const img = document.createElement('img');
        img.alt = `Cartela ${c.id}`;
        img.style.background = 'white';

        const formatos = ['png', 'jpg', 'jpeg', 'svg'];
        let carregada = false;

        for (let ext of formatos) {
          const caminho = `assets/cart${c.id}.${ext}`;
          const testeImg = new Image();
          testeImg.src = caminho;
          testeImg.onload = () => {
            if (!carregada) {
              carregada = true;
              img.src = caminho;
            }
          };
        }

        setTimeout(() => {
          if (!carregada) {
            img.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjgwIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxwYXRoIGQ9Ik0wIDBoMTAwdjgwaC0xMDB6IiBmaWxsPSIjY2NjIi8+PHRleHQgeD0iNTAiIHk9IjQ1IiBmb250LXNpemU9IjEyIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSIjZmZmIj5ObyBJbWFnZW08L3RleHQ+PC9zdmc+';
          }
        }, 1000);

        card.appendChild(img);

        const status = document.createElement('div');
        status.className = 'status ' + c.status;
        status.textContent = c.status.charAt(0).toUpperCase() + c.status.slice(1);
        card.appendChild(status);

        const btnVer = document.createElement('button');
        btnVer.className = 'btn-ver';
        btnVer.textContent = 'Ver cartela';
        btnVer.onclick = (e) => {
          e.stopPropagation();
          abrirModal(img.src, c.id);
        };
        card.appendChild(btnVer);

        cardsDiv.appendChild(card);
      });

      seqDiv.appendChild(h2);
      seqDiv.appendChild(cardsDiv);
      container.appendChild(seqDiv);
      sequencias.push({ div: seqDiv, cardsDiv });
    }

    function atualizarBotaoFixo() {
      const qtd = selecionadas.size;
      if (qtd > 0) {
        botaoFixo.style.display = 'block';
        botaoFixo.textContent = `ðŸ“± Reservar (${qtd} cartela${qtd > 1 ? 's' : ''})`;
      } else {
        botaoFixo.style.display = 'none';
      }
    }

    function atualizarListaSelecionadas() {
      listaSelecionadas.innerHTML = '';
      Array.from(selecionadas).sort((a, b) => a - b).forEach(id => {
        const li = document.createElement('li');
        li.textContent = `Cartela ${id}`;
        listaSelecionadas.appendChild(li);
      });
    }

    function abrirModal(imagem, id) {
      imagemReal.src = imagem;
      imagemReal.alt = `Cartela ${id}`;
      modalImagem.style.display = 'flex';
    }

    function fecharModal(event) {
      if (event) event.stopPropagation();
      modalImagem.style.display = 'none';
      imagemReal.src = '';
    }

    function abrirFormulario() {
      atualizarListaSelecionadas();
      popupBg.style.display = 'flex';
    }

    function fecharFormulario() {
      popupBg.style.display = 'none';
    }

    function enviarReserva() {
      const nome = document.getElementById('nome').value.trim();
      const whatsapp = document.getElementById('whatsapp').value.trim();

      if (nome === '' || whatsapp === '') {
        alert('Por favor, preencha nome e WhatsApp.');
        return;
      }

      if (selecionadas.size === 0) {
        alert('Selecione pelo menos uma cartela para reservar.');
        return;
      }

      const cartelasText = Array.from(selecionadas).sort((a, b) => a - b).join(', ');
      const msg = `OlÃ¡, quero reservar as cartelas: ${cartelasText}. Nome: ${nome}. WhatsApp: ${whatsapp}`;
      const urlWhats = `https://wa.me/5591980499217?text=${encodeURIComponent(msg)}`;
      window.open(urlWhats, '_blank');

      alert('Reserva enviada!');
      selecionadas.clear();
      atualizarBotaoFixo();
      fecharFormulario();
      document.querySelectorAll('.card input[type=checkbox]').forEach(chk => chk.checked = false);
    }

    carregarCartelas();
  </script>
</body>
</html>
